@model IdentityService.Web.ViewModels.RolePermissionMappingViewModel
@{
    ViewData["Title"] = "Role Permission Mapping";
}

<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="bi bi-diagram-3 text-primary me-2"></i>
            Role Permission Mapping
        </h1>
        <p class="page-subtitle">Assign granular permissions to roles by module</p>
    </div>
    @if (!string.IsNullOrEmpty(Model.SelectedModule) && !string.IsNullOrEmpty(Model.SelectedRoleId))
    {
        <div class="d-flex align-items-center gap-2">
            <span class="badge badge-soft-primary fs-6 px-3 py-2">
                <i class="bi bi-box-seam me-1"></i> @Model.SelectedModule
            </span>
            <i class="bi bi-chevron-right text-muted"></i>
            <span class="badge badge-soft-success fs-6 px-3 py-2">
                <i class="bi bi-shield me-1"></i> @Model.SelectedRoleName
            </span>
        </div>
    }
</div>

<!-- Wizard-style Steps -->
<div class="card mb-5 border-0" style="background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);">
    <div class="card-body py-4">
        <div class="d-flex align-items-center justify-content-center gap-4">
            <!-- Step 1: Module -->
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center @(string.IsNullOrEmpty(Model.SelectedModule) ? "bg-primary text-white" : "bg-success text-white")" 
                     style="width: 40px; height: 40px; font-weight: 600;">
                    @if (string.IsNullOrEmpty(Model.SelectedModule))
                    {
                        <span>1</span>
                    }
                    else
                    {
                        <i class="bi bi-check-lg"></i>
                    }
                </div>
                <div class="@(!string.IsNullOrEmpty(Model.SelectedModule) ? "text-success" : "")">
                    <div class="fw-semibold">Select Module</div>
                    <div class="text-sm text-muted">Choose target service</div>
                </div>
            </div>
            
            <div class="flex-grow-0" style="width: 60px; height: 2px; background: var(--gray-200);"></div>
            
            <!-- Step 2: Role -->
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center @(!string.IsNullOrEmpty(Model.SelectedRoleId) ? "bg-success text-white" : (string.IsNullOrEmpty(Model.SelectedModule) ? "bg-light text-muted" : "bg-primary text-white"))" 
                     style="width: 40px; height: 40px; font-weight: 600;">
                    @if (!string.IsNullOrEmpty(Model.SelectedRoleId))
                    {
                        <i class="bi bi-check-lg"></i>
                    }
                    else
                    {
                        <span>2</span>
                    }
                </div>
                <div class="@(!string.IsNullOrEmpty(Model.SelectedRoleId) ? "text-success" : (string.IsNullOrEmpty(Model.SelectedModule) ? "text-muted" : ""))">
                    <div class="fw-semibold">Select Role</div>
                    <div class="text-sm text-muted">Pick role to configure</div>
                </div>
            </div>
            
            <div class="flex-grow-0" style="width: 60px; height: 2px; background: var(--gray-200);"></div>
            
            <!-- Step 3: Permissions -->
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center @(string.IsNullOrEmpty(Model.SelectedRoleId) ? "bg-light text-muted" : "bg-primary text-white")" 
                     style="width: 40px; height: 40px; font-weight: 600;">
                    <span>3</span>
                </div>
                <div class="@(string.IsNullOrEmpty(Model.SelectedRoleId) ? "text-muted" : "")">
                    <div class="fw-semibold">Assign Permissions</div>
                    <div class="text-sm text-muted">Configure access rights</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module Selection Card -->
<div class="card mb-5">
    <div class="card-body">
        <form method="get" asp-action="Index" id="moduleForm">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-4">
                        <div class="avatar avatar-xl avatar-primary">
                            <i class="bi bi-box-seam fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <label class="section-title mb-2">Target Module</label>
                            <select name="module" class="form-select form-select-lg" onchange="this.form.submit()">
                                <option value="">-- Select a Module --</option>
                                @foreach (var module in Model.AvailableModules)
                                {
                                    <option value="@module" selected="@(module == Model.SelectedModule)">@module</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    @if (string.IsNullOrEmpty(Model.SelectedModule))
                    {
                        <div class="d-flex align-items-start gap-3 p-4 rounded-3" style="background: var(--info-soft);">
                            <i class="bi bi-lightbulb fs-4 text-info"></i>
                            <div>
                                <div class="fw-medium text-info-emphasis">Getting Started</div>
                                <div class="text-sm" style="color: #1e40af;">
                                    Select a module to see its roles. Each module represents a microservice with its own set of roles and permissions.
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </form>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.SelectedModule))
{
    <div class="row g-4">
        <!-- Roles List -->
        <div class="col-lg-4">
            <div class="card h-100" style="border: 2px solid @(!string.IsNullOrEmpty(Model.SelectedRoleId) ? "var(--gray-200)" : "var(--primary)");">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar avatar-success">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-semibold">Roles</h5>
                            <p class="text-muted text-sm mb-0">in @Model.SelectedModule</p>
                        </div>
                    </div>
                    <span class="badge bg-light text-dark">@Model.RolesInModule.Count</span>
                </div>
                <div class="card-body p-0" style="max-height: 480px; overflow-y: auto;">
                    @if (Model.RolesInModule.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var role in Model.RolesInModule)
                            {
                                var isActive = role.Id == Model.SelectedRoleId;
                                <a asp-action="Index" 
                                   asp-route-module="@Model.SelectedModule" 
                                   asp-route-roleId="@role.Id" 
                                   class="list-group-item list-group-item-action @(isActive ? "active" : "") py-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar avatar-sm @(isActive ? "" : "bg-light")" style="@(isActive ? "background: rgba(255,255,255,0.2);" : "")">
                                                <i class="bi bi-person-badge @(isActive ? "text-white" : "text-muted")"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@role.Name</div>
                                                @if (!string.IsNullOrEmpty(role.Description))
                                                {
                                                    <div class="text-sm @(isActive ? "opacity-75" : "text-muted") line-clamp-2">@role.Description</div>
                                                }
                                            </div>
                                        </div>
                                        <i class="bi bi-chevron-right @(isActive ? "" : "text-muted")"></i>
                                    </div>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state py-6">
                            <i class="bi bi-shield-x" style="font-size: 3rem; color: var(--gray-300);"></i>
                            <h6 class="mt-3 text-muted fw-semibold">No Roles Found</h6>
                            <p class="text-muted text-sm mb-3">Create roles for this module first</p>
                            <a asp-controller="Roles" asp-action="Index" asp-route-module="@Model.SelectedModule" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-lg"></i> Create Role
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Permissions Tree -->
        <div class="col-lg-8">
            @if (!string.IsNullOrEmpty(Model.SelectedRoleId))
            {
                <div class="card h-100" style="border: 2px solid var(--primary);">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar avatar-warning">
                                <i class="bi bi-key"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 fw-semibold">Permissions</h5>
                                <p class="text-muted text-sm mb-0">for <span class="text-primary fw-medium">@Model.SelectedRoleName</span></p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-light" onclick="selectAll()">
                                <i class="bi bi-check-all"></i> All
                            </button>
                            <button type="button" class="btn btn-sm btn-light" onclick="deselectAll()">
                                <i class="bi bi-x-lg"></i> None
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <form method="post" asp-action="Assign" id="permissionForm">
                            <input type="hidden" name="roleId" value="@Model.SelectedRoleId" />
                            <input type="hidden" name="module" value="@Model.SelectedModule" />
                            
                            @if (Model.PermissionTree.Any())
                            {
                                <div class="permission-tree p-4" style="max-height: 400px; overflow-y: auto;">
                                    @{ var categoryIndex = 0; }
                                    @foreach (var category in Model.PermissionTree)
                                    {
                                        var assignedCount = category.Value.Count(p => p.IsAssigned);
                                        var totalCount = category.Value.Count;
                                        var isAllAssigned = assignedCount == totalCount;
                                        var isPartialAssigned = assignedCount > 0 && assignedCount < totalCount;
                                        
                                        <div class="tree-category mb-4">
                                            <div class="category-header p-3 rounded-3 cursor-pointer d-flex align-items-center justify-content-between" 
                                                 style="background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);"
                                                 onclick="toggleCategoryCollapse('@category.Key.Replace(" ", "_")')">
                                                <div class="form-check mb-0">
                                                    <input class="form-check-input category-checkbox" 
                                                           type="checkbox" 
                                                           id="category_@category.Key.Replace(" ", "_")"
                                                           data-category="@category.Key"
                                                           onchange="toggleCategory(this); event.stopPropagation();"
                                                           @(isAllAssigned ? "checked" : "")>
                                                    <label class="form-check-label fw-semibold cursor-pointer" for="category_@category.Key.Replace(" ", "_")" onclick="event.stopPropagation();">
                                                        <i class="bi bi-folder2-open text-warning me-2"></i>
                                                        @category.Key
                                                    </label>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge @(isAllAssigned ? "badge-soft-success" : (isPartialAssigned ? "badge-soft-warning" : "bg-light text-muted"))">
                                                        @assignedCount / @totalCount
                                                    </span>
                                                    <i class="bi bi-chevron-down text-muted transition-all" id="chevron_@category.Key.Replace(" ", "_")"></i>
                                                </div>
                                            </div>
                                            <div class="category-permissions ms-4 mt-3" id="collapse_@category.Key.Replace(" ", "_")">
                                                <div class="row g-2">
                                                    @foreach (var permission in category.Value)
                                                    {
                                                        <div class="col-md-6">
                                                            <div class="form-check p-3 rounded-3 permission-item transition-all h-100 @(permission.IsAssigned ? "bg-primary bg-opacity-10 border border-primary border-opacity-25" : "bg-light border border-transparent")" 
                                                                 data-category="@category.Key">
                                                                <input class="form-check-input permission-checkbox" 
                                                                       type="checkbox" 
                                                                       name="selectedPermissions" 
                                                                       value="@permission.Id" 
                                                                       id="perm_@permission.Id"
                                                                       checked="@permission.IsAssigned"
                                                                       onchange="updateCategoryCheckbox(this); updatePermissionStyle(this);">
                                                                <label class="form-check-label w-100 cursor-pointer" for="perm_@permission.Id">
                                                                    <div class="fw-medium text-sm">@permission.Name</div>
                                                                    @if (!string.IsNullOrEmpty(permission.Description))
                                                                    {
                                                                        <div class="text-muted text-xs mt-1 line-clamp-2">@permission.Description</div>
                                                                    }
                                                                </label>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        categoryIndex++;
                                    }
                                </div>

                                <div class="p-4 border-top d-flex justify-content-between align-items-center" style="background: linear-gradient(to top, var(--gray-50), white);">
                                    <div class="d-flex align-items-center gap-2 text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        <span class="text-sm">Changes take effect immediately after saving</span>
                                    </div>
                                    <div class="d-flex gap-3">
                                        <a asp-action="Index" asp-route-module="@Model.SelectedModule" class="btn btn-secondary">
                                            <i class="bi bi-arrow-left"></i> Back
                                        </a>
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="bi bi-check-lg"></i> Save Permissions
                                        </button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <i class="bi bi-shield-x empty-state-icon" style="font-size: 3rem;"></i>
                                    <h5 class="empty-state-title">No Permissions Available</h5>
                                    <p class="empty-state-text">Create permissions for this module first, then assign them to roles.</p>
                                    <a asp-controller="Permissions" asp-action="Index" class="btn btn-primary">
                                        <i class="bi bi-plus-lg"></i> Create Permissions
                                    </a>
                                </div>
                            }
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card h-100 border-dashed" style="border-style: dashed; border-width: 2px;">
                    <div class="empty-state h-100 d-flex flex-column justify-content-center">
                        <div class="avatar avatar-xl avatar-primary mx-auto mb-4">
                            <i class="bi bi-hand-index fs-3"></i>
                        </div>
                        <h5 class="empty-state-title">Select a Role</h5>
                        <p class="empty-state-text">Choose a role from the list on the left to configure its permissions.</p>
                    </div>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="card border-dashed" style="border-style: dashed; border-width: 2px;">
        <div class="empty-state">
            <div class="avatar avatar-xl avatar-primary mx-auto mb-4">
                <i class="bi bi-box-seam fs-3"></i>
            </div>
            <h5 class="empty-state-title">Select a Module</h5>
            <p class="empty-state-text">Choose a service module above to view its roles and configure permissions.</p>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize category checkbox states
            document.querySelectorAll('.category-checkbox').forEach(function(categoryCheckbox) {
                updateCategoryCheckboxState(categoryCheckbox);
            });
        });

        function toggleCategory(checkbox) {
            const category = checkbox.dataset.category;
            const container = checkbox.closest('.tree-category');
            const permissionCheckboxes = container.querySelectorAll('.permission-checkbox');
            
            permissionCheckboxes.forEach(function(permCheckbox) {
                permCheckbox.checked = checkbox.checked;
                updatePermissionStyle(permCheckbox);
            });
        }

        function updateCategoryCheckbox(permissionCheckbox) {
            const container = permissionCheckbox.closest('.tree-category');
            const categoryCheckbox = container.querySelector('.category-checkbox');
            
            if (categoryCheckbox) {
                updateCategoryCheckboxState(categoryCheckbox);
            }
        }

        function updateCategoryCheckboxState(categoryCheckbox) {
            const container = categoryCheckbox.closest('.tree-category');
            const permissionCheckboxes = Array.from(container.querySelectorAll('.permission-checkbox'));
            
            if (permissionCheckboxes.length === 0) return;
            
            const checkedCount = permissionCheckboxes.filter(cb => cb.checked).length;
            
            if (checkedCount === 0) {
                categoryCheckbox.checked = false;
                categoryCheckbox.indeterminate = false;
            } else if (checkedCount === permissionCheckboxes.length) {
                categoryCheckbox.checked = true;
                categoryCheckbox.indeterminate = false;
            } else {
                categoryCheckbox.checked = false;
                categoryCheckbox.indeterminate = true;
            }
            
            // Update badge
            const badge = container.querySelector('.badge');
            if (badge) {
                badge.className = checkedCount === permissionCheckboxes.length 
                    ? 'badge badge-soft-success' 
                    : (checkedCount > 0 ? 'badge badge-soft-warning' : 'badge bg-light text-muted');
                badge.textContent = checkedCount + ' / ' + permissionCheckboxes.length;
            }
        }

        function updatePermissionStyle(checkbox) {
            const item = checkbox.closest('.permission-item');
            if (checkbox.checked) {
                item.classList.add('bg-primary', 'bg-opacity-10', 'border-primary', 'border-opacity-25');
                item.classList.remove('bg-light', 'border-transparent');
            } else {
                item.classList.remove('bg-primary', 'bg-opacity-10', 'border-primary', 'border-opacity-25');
                item.classList.add('bg-light', 'border-transparent');
            }
        }

        function toggleCategoryCollapse(categoryKey) {
            const collapse = document.getElementById('collapse_' + categoryKey);
            const chevron = document.getElementById('chevron_' + categoryKey);
            
            if (collapse.style.display === 'none') {
                collapse.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                collapse.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function selectAll() {
            document.querySelectorAll('.permission-checkbox').forEach(function(cb) {
                cb.checked = true;
                updatePermissionStyle(cb);
            });
            document.querySelectorAll('.category-checkbox').forEach(function(cb) {
                cb.checked = true;
                cb.indeterminate = false;
                updateCategoryCheckboxState(cb);
            });
        }

        function deselectAll() {
            document.querySelectorAll('.permission-checkbox').forEach(function(cb) {
                cb.checked = false;
                updatePermissionStyle(cb);
            });
            document.querySelectorAll('.category-checkbox').forEach(function(cb) {
                cb.checked = false;
                cb.indeterminate = false;
                updateCategoryCheckboxState(cb);
            });
        }
    </script>
}

<style>
    .form-check-input:indeterminate {
        background-color: var(--warning);
        border-color: var(--warning);
    }
    
    .permission-item {
        cursor: pointer;
    }
    
    .permission-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .category-header:hover {
        background: var(--gray-100) !important;
    }
    
    .border-dashed {
        border-color: var(--gray-300) !important;
    }
</style>
